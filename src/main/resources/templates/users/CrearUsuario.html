<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout('Usuarios', ~{::section})}">

<section>
    <h2>Crear usuario</h2>

    <form th:action="@{/users}" method="post" th:object="${form}" class="form">

        <div th:if="${#fields.hasGlobalErrors()}" class="error"
             th:text="${#fields.globalErrors()[0].defaultMessage}"></div>

        <div>
            <label>Username</label>
            <input type="text" th:field="*{username}" data-required data-minlen="3">
            <div class="error" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></div>
        </div>

        <div>
            <label>Password</label>
            <input type="password" th:field="*{password}" data-required data-minlen="4">
            <div class="error" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>
        </div>

        <!-- Rol (hardcodeado) -->
        <div class="mb-3">
            <label for="rol" class="form-label">Rol</label>

            <select id="rol" class="form-select" th:field="*{rol}" data-required>
                <option value="">-- Seleccionar --</option>
                <option value="ADMIN">ADMIN</option>
                <option value="INVESTIGADOR">INVESTIGADOR</option>
                <option value="VIGILANTE">VIGILANTE</option>
                <option value="USER">USER</option>
            </select>

            <div class="error" th:if="${#fields.hasErrors('rol')}" th:errors="*{rol}"></div>
        </div>

        <!-- Vigilante -->
        <div id="vigilanteGroup" class="mb-3" style="display:none;">
            <label for="vigilanteId" class="form-label">Vigilante</label>

            <select id="vigilanteId" class="form-select" th:field="*{vigilanteId}">
                <option value="">-- Seleccionar vigilante --</option>
                <option th:each="v : ${vigilantes}"
                        th:value="${v.id}"
                        th:text="${v.id + ' - ' + v.codigo}">
                </option>
            </select>

            <div class="error" th:if="${#fields.hasErrors('vigilanteId')}" th:errors="*{vigilanteId}"></div>

            <div class="form-text">Obligatorio si el rol es VIGILANTE.</div>

            <div th:if="${!hayVigilantes}" class="muted">
                (No hay vigilantes disponibles para asociar. Podés crear igual sin asignar.)
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" type="submit">Guardar</button>
            <a class="btn" th:href="@{/users}">Cancelar</a>
        </div>

    </form>

    <!-- ✅ IMPORTANTE: el script DEBE estar dentro del section -->
    <script th:inline="javascript">
        (function () {
          const rol = document.getElementById('rol');
          const vigilanteGroup = document.getElementById('vigilanteGroup');
          const vigilanteId = document.getElementById('vigilanteId');

          const hayVigilantes = /*[[${hayVigilantes}]]*/ false;

          if (!rol || !vigilanteGroup || !vigilanteId) return;

          function syncVigilanteRequirement() {
            const isVigilante = (rol.value === 'VIGILANTE');

            // console.log('ROL:', rol.value, 'isVigilante:', isVigilante); // (opcional)

            vigilanteGroup.style.display = isVigilante ? '' : 'none';

            if (isVigilante && hayVigilantes) {
              vigilanteId.setAttribute('data-required', 'true');
              vigilanteId.setAttribute('required', 'required');
            } else {
              vigilanteId.removeAttribute('data-required');
              vigilanteId.removeAttribute('required');

              if (!isVigilante) vigilanteId.value = '';
            }
          }

          syncVigilanteRequirement();
          rol.addEventListener('change', syncVigilanteRequirement);
        })();
    </script>

</section>
</html>