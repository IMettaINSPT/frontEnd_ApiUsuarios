<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout('Usuarios', ~{::section})}">

<section>
  <h2>Detalle / Editar usuario</h2>

  <div th:if="${msg}" class="ok" th:text="${msg}"></div>
  <div th:if="${error}" class="error" th:text="${error}"></div>

  <!-- info solo lectura -->
  <div class="mb-3">
    <div><b>ID:</b> <span th:text="${user.id}"></span></div>
    <div><b>Username:</b> <span th:text="${user.username}"></span></div>
  </div>

  <form th:action="@{/users/{id}(id=${user.id})}"
        method="post"
        th:object="${update}"
        class="form">

    <div th:if="${#fields.hasGlobalErrors()}" class="error"
         th:text="${#fields.globalErrors()[0].defaultMessage}"></div>

    <!-- Password opcional -->
    <div>
      <label>Password (dejar vacío para no cambiar)</label>
      <input type="password" th:field="*{password}">
      <div class="error" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>
    </div>

    <!-- Enabled -->
    <div class="mb-3">
      <label>
        <input type="checkbox" th:field="*{enabled}">
        Enabled
      </label>
      <div class="error" th:if="${#fields.hasErrors('enabled')}" th:errors="*{enabled}"></div>
    </div>

    <!-- Rol (hardcodeado) -->
    <div class="mb-3">
      <label for="rol" class="form-label">Rol</label>
      <select id="rol" class="form-select" th:field="*{rol}" data-required>
        <option value="">-- Seleccionar --</option>
        <option value="ADMIN">ADMIN</option>
        <option value="INVESTIGADOR">INVESTIGADOR</option>
        <option value="VIGILANTE">VIGILANTE</option>
        <option value="USER">USER</option>
      </select>
      <div class="error" th:if="${#fields.hasErrors('rol')}" th:errors="*{rol}"></div>
    </div>

    <!-- Vigilante -->
    <div id="vigilanteGroup" class="mb-3" style="display:none;">
      <label for="vigilanteId" class="form-label">Vigilante</label>
      <select id="vigilanteId" class="form-select" th:field="*{vigilanteId}">
        <option value="">-- Seleccionar vigilante --</option>
        <option th:each="v : ${vigilantes}"
                th:value="${v.id}"
                th:text="${v.id + ' - ' + v.codigo}">
        </option>
      </select>

      <div class="error" th:if="${#fields.hasErrors('vigilanteId')}" th:errors="*{vigilanteId}"></div>

      <div class="form-text">Obligatorio si el rol es VIGILANTE.</div>

      <div th:if="${!hayVigilantes}" class="muted">
        (No hay vigilantes disponibles para asociar. Podés guardar igual sin asignar.)
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" type="submit">Guardar cambios</button>
      <a class="btn" th:href="@{/users}">Volver</a>
    </div>
  </form>

  <!-- ✅ script dentro del section -->
  <script th:inline="javascript">
    (function () {
      const rol = document.getElementById('rol');
      const vigilanteGroup = document.getElementById('vigilanteGroup');
      const vigilanteId = document.getElementById('vigilanteId');

      const hayVigilantes = /*[[${hayVigilantes}]]*/ false;

      if (!rol || !vigilanteGroup || !vigilanteId) return;

      function sync() {
        const isVigilante = (rol.value === 'VIGILANTE');
        vigilanteGroup.style.display = isVigilante ? '' : 'none';

        if (isVigilante && hayVigilantes) {
          vigilanteId.setAttribute('data-required', 'true');
          vigilanteId.setAttribute('required', 'required');
        } else {
          vigilanteId.removeAttribute('data-required');
          vigilanteId.removeAttribute('required');
          if (!isVigilante) vigilanteId.value = '';
        }
      }

      sync();
      rol.addEventListener('change', sync);
    })();
  </script>

</section>
</html>